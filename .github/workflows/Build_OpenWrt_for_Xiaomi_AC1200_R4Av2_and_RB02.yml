name: Build OpenWrt for Xiaomi AC1200 R4Av2 and RB02

on:
  workflow_dispatch:                     # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    tags:                                # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–≥–∞
      - 'v*'                             # –ù–∞–ø—Ä–∏–º–µ—Ä: v1.0, v2.0

jobs:
  Build:
    name: Build ${{ matrix.device }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - device: Xiaomi_R4Av2
            config: xiaomi_mi-router-4a-gigabit-v2.config
            file_part: xiaomi_mi-router-4a-gigabit-v2
          - device: Xiaomi_AC1200_RB02
            config: xiaomi_mi-router-ac1200-rb02.config
            file_part: xiaomi_mi-router-ac1200
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential asciidoc binutils bzip2 gawk gettext git \
          libncurses5-dev libz-dev libssl-dev libelf-dev unzip zlib1g-dev \
          python3 python3-pip liblzma-dev device-tree-compiler p7zip-full rsync \
          time
    
    - name: Clone OpenWRT source
      run: |
        git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout main  # ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º main –≤–µ—Ç–∫—É
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Apply device configuration
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        if [ ! -f "configs/${{ matrix.config }}" ]; then
          echo "‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: configs/${{ matrix.config }}"
          exit 1
        fi
        cp "configs/${{ matrix.config }}" openwrt/.config
        cd openwrt
        make defconfig
    
    - name: Prepare custom configuration files
      run: |
        mkdir -p openwrt/files/etc/config
        
        # HTTPS DNS Proxy: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ DoH —á–µ—Ä–µ–∑ Cloudflare
        cat <<EOF > openwrt/files/etc/config/https-dns-proxy
        config https-dns-proxy
            option instance 'cloudflare'
            option bootstrap_dns '1.1.1.1,1.0.0.1'
            option dns_servers '1.1.1.1,1.0.0.1'
            option resolver_url 'https://cloudflare-dns.com/dns-query'
            option listen_addr '127.0.0.1'
            option listen_port '5053'
            option user 'nobody'
            option group 'nogroup'
        EOF
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Dnsmasq –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å DoH-–ø—Ä–æ–∫—Å–∏
        mkdir -p openwrt/files/etc/uci-defaults
        cat <<'EOF' > openwrt/files/etc/uci-defaults/99-dns-setup
        #!/bin/sh
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS: Dnsmasq -> HTTPS DNS Proxy
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ DNS-—Å–µ—Ä–≤–µ—Ä—ã
        uci del dhcp.@dnsmasq[0].server 2>/dev/null
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π DoH-–ø—Ä–æ–∫—Å–∏
        uci add_list dhcp.@dnsmasq[0].server='127.0.0.1#5053'
        
        # –û—Ç–∫–ª—é—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ /etc/resolv.conf
        uci set dhcp.@dnsmasq[0].noresolv='1'
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        uci commit dhcp
        
        exit 0
        EOF
        chmod +x openwrt/files/etc/uci-defaults/99-dns-setup
        
        # SQM: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–æ—Å–æ–π –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è
        cat <<EOF > openwrt/files/etc/config/sqm
        config queue 'wan'
            option enabled '0'           # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫–ª—é—á–µ–Ω
            option interface 'wan'       # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å WAN
            option download '85000'      # –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ (85 Mbps)
            option upload '85000'        # –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–¥–∞—á–∏ (85 Mbps)
            option qdisc 'cake'          # –ê–ª–≥–æ—Ä–∏—Ç–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥—è–º–∏
            option script 'piece_of_cake.qos'  # –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            option linklayer 'ethernet'  # –¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        EOF
    
    - name: Build firmware image
      run: |
        cd openwrt
        echo "üõ†Ô∏è  –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ –ø—Ä–æ—à–∏–≤–∫–∏: $(date)"
        echo "üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${{ matrix.device }}"
        
        # –°–±–æ—Ä–∫–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —è–¥–µ—Ä
        time make -j$(($(nproc) + 1)) || make -j1 V=s
        
        echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(date)"
        echo "BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M')" >> $GITHUB_ENV
    
    - name: Collect build artifacts
      run: |
        mkdir -p "output/${{ matrix.device }}"
        
        # –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–∞ –ø—Ä–æ—à–∏–≤–∫–∏
        FIRMWARE_FILE=$(find openwrt/bin/targets/ramips/mt7621/ \
          -name "*${{ matrix.file_part }}*squashfs-sysupgrade.bin" \
          -type f | head -1)
        
        if [ -f "$FIRMWARE_FILE" ]; then
          echo "üì¶ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª –ø—Ä–æ—à–∏–≤–∫–∏: $(basename "$FIRMWARE_FILE")"
          cp "$FIRMWARE_FILE" "output/${{ matrix.device }}/"
          cp openwrt/.config "output/${{ matrix.device }}/build.config"
        else
          echo "‚ùå –§–∞–π–ª –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
    
    - name: Upload artifacts to workflow
      uses: actions/upload-artifact@v4
      with:
        name: "${{ matrix.device }}_${{ env.BUILD_TIMESTAMP }}"
        path: "output/${{ matrix.device }}/*"
        retention-days: 7

  Release:
    name: Create GitHub Release
    needs: Build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          echo "üîê –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º..."
          find . -name "*.bin" -type f -exec sha256sum {} \; > SHA256SUMS
          echo "‚úÖ –•–µ—à–∏ —Å–æ–∑–¥–∞–Ω—ã:"
          cat SHA256SUMS
      
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: "OpenWrt 2026 –¥–ª—è Xiaomi (${{ github.ref_name }})"
          body: |
            ## üöÄ OpenWrt 2026 Edition
            
            ### üì± –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏:
            - **Xiaomi Mi Router 4A Gigabit v2** (R4Av2)
            - **Xiaomi Mi Router AC1200** (RB02)
            
            ### üîß –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏:
            ‚úÖ **Zapret** ‚Äî –æ–±—Ö–æ–¥ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (nfqws).  
            ‚úÖ **DoH DNS** ‚Äî –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DNS —á–µ—Ä–µ–∑ Cloudflare.  
            ‚úÖ **WireGuard** ‚Äî –±—ã—Å—Ç—Ä—ã–π VPN.  
            ‚úÖ **SQM Cake** ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–∏–Ω–≥ –≤ –∏–≥—Ä–∞—Ö.  
            ‚úÖ **Mesh Wi-Fi** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 802.11s.  
            ‚úÖ **ZRAM** ‚Äî —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –Ω–∞ 128MB RAM.  
            ‚úÖ **–†—É—Å—Å–∫–∏–π LuCI**.
            
            ### ‚öôÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ:
            1. –ü—Ä–æ—à–µ–π—Ç–µ —Ñ–∞–π–ª `sysupgrade.bin` —á–µ—Ä–µ–∑ **LuCI** –∏–ª–∏ **Breed**
            2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
            3. –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
            
            ### ‚ö° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
            - **SQM** –≤–∫–ª—é—á–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –Ω–∏–∑–∫–∏–π –ø–∏–Ω–≥
            - **Zapret** –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
            - **Mesh** –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Å–µ—Ç–∏
            
            *–°–±–æ—Ä–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è 16MB Flash –ø–∞–º—è—Ç–∏.*
            
            ### üîí –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã:
            ```
            $(cat artifacts/SHA256SUMS 2>/dev/null || echo "–•–µ—à–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏")
            ```
          files: |
            artifacts/**/*.bin
            artifacts/SHA256SUMS