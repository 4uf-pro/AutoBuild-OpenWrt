name: Build OpenWrt for Xiaomi AC1200 R4Av2 and RB02

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

jobs:
  Build-Xiaomi-R4Av2-MT7621:
    name: Build Xiaomi R4Av2 (MT7621)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev libssl-dev libelf-dev unzip zlib1g-dev python3 python3-pip liblzma-dev device-tree-compiler p7zip-full rsync
    
    - name: Clone source code
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout master
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load custom configuration for R4Av2
      run: |
        cp configs/xiaomi_mi-router-4a-gigabit-v2.config build.config
        sed -i 's|\r$||g' build.config
        cat build.config > openwrt/.config
        cd openwrt
        make defconfig

    - name: Add optimized SQM defaults
      run: |
        mkdir -p openwrt/files/etc/config
        cat <<EOF > openwrt/files/etc/config/sqm
        config queue 'wan'
            option enabled '0'
            option interface 'wan'
            option download '85000'
            option upload '85000'
            option qdisc 'cake'
            option script 'piece_of_cake.qos'
            option linklayer 'ethernet'
            option ingress_ecn 'ECN'
            option egress_ecn 'ECN'
        EOF

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(($(nproc) + 1)) || make -j1 V=s
        BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')
        echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_ENV
        
        if ls bin/targets/ramips/mt7621/*.bin 1>/dev/null 2>&1; then
          echo "FIRMWARE_BUILT=true" >> $GITHUB_ENV
        else
          echo "FIRMWARE_BUILT=false" >> $GITHUB_ENV
          exit 1
        fi
    
    - name: Upload firmware with config
      if: env.FIRMWARE_BUILT == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Xiaomi_R4Av2_OpenWrt_${{ env.BUILD_TIMESTAMP }}
        path: |
          openwrt/bin/targets/ramips/mt7621/openwrt-*-xiaomi_mi-router-4a-gigabit-v2-squashfs-sysupgrade.bin
          build.config

  Build-Xiaomi-AC1200-RB02-MT7621:
    name: Build Xiaomi AC1200 RB02 (MT7621)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev libssl-dev libelf-dev unzip zlib1g-dev python3 python3-pip liblzma-dev device-tree-compiler p7zip-full rsync
    
    - name: Clone source code
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout master
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load custom configuration for AC1200 RB02
      run: |
        cp configs/xiaomi_mi-router-ac1200-rb02.config build.config
        sed -i 's|\r$||g' build.config
        cat build.config > openwrt/.config
        cd openwrt
        make defconfig

    - name: Add optimized SQM defaults
      run: |
        mkdir -p openwrt/files/etc/config
        cat <<EOF > openwrt/files/etc/config/sqm
        config queue 'wan'
            option enabled '0'
            option interface 'wan'
            option download '85000'
            option upload '85000'
            option qdisc 'cake'
            option script 'piece_of_cake.qos'
            option linklayer 'ethernet'
            option ingress_ecn 'ECN'
            option egress_ecn 'ECN'
        EOF

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(($(nproc) + 1)) || make -j1 V=s
        BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')
        echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_ENV
        
        if ls bin/targets/ramips/mt7621/*.bin 1>/dev/null 2>&1; then
          echo "FIRMWARE_BUILT=true" >> $GITHUB_ENV
        else
          echo "FIRMWARE_BUILT=false" >> $GITHUB_ENV
          exit 1
        fi
    
    - name: Rename firmware for RB02
      if: env.FIRMWARE_BUILT == 'true'
      run: |
        cd openwrt/bin/targets/ramips/mt7621/
        OLD_FW=$(ls openwrt-*-xiaomi_mi-router-ac1200-squashfs-sysupgrade.bin 2>/dev/null | head -1)
        if [ -n "$OLD_FW" ]; then
          NEW_FW="${OLD_FW/xiaomi_mi-router-ac1200/xiaomi_mi-router-ac1200-rb02}"
          cp "$OLD_FW" "$NEW_FW"
        fi
    
    - name: Upload firmware with config
      if: env.FIRMWARE_BUILT == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Xiaomi_AC1200_RB02_OpenWrt_${{ env.BUILD_TIMESTAMP }}
        path: |
          openwrt/bin/targets/ramips/mt7621/openwrt-*-xiaomi_mi-router-ac1200-rb02-squashfs-sysupgrade.bin
          build.config
  
  Create-Release:
    name: Create Release
    needs: [Build-Xiaomi-R4Av2-MT7621, Build-Xiaomi-AC1200-RB02-MT7621]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare files for release
        run: |
          mkdir -p release_files
          
          find artifacts -name "*.bin" -exec cp {} release_files/ \;
          
          find artifacts -name "*_R4Av2_OpenWrt_*" -type d -exec cp {}/build.config release_files/config_Xiaomi_R4Av2.txt \; 2>/dev/null || true
          find artifacts -name "*_AC1200_RB02_OpenWrt_*" -type d -exec cp {}/build.config release_files/config_Xiaomi_AC1200_RB02.txt \; 2>/dev/null || true
      
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_files/*
          body: |
            ## OpenWrt прошивки для Xiaomi роутеров
            
            ### Совместимые устройства:
            - **Xiaomi R4A v2** (Mi Router 4A Gigabit v2)
            - **Xiaomi AC1200** (RB02)
            
            ### Включенные компоненты:
            ✅ Zapret2 с nfqws (автообход блокировок)  
            ✅ WireGuard + Tailscale VPN  
            ✅ SmartDNS + AdBlock  
            ✅ Оптимизация QoS для игр (SQM Cake)  
            ✅ Полный мониторинг  
            ✅ Русский интерфейс LuCI
            
            ### Настройка SQM для 100/100 Мбит:
            1. LuCI → Network → SQM QoS
            2. Enable SQM: ✅ ВКЛ
            3. Download: **85000** (готово)
            4. Upload: **85000** (готово)
            5. Queue: **cake** (готово)
            6. Save & Apply
            
            ### Важно:
            - Прошивка оптимизирована под MT7621 процессор
            - Используйте правильный файл для вашей модели
            - Первая загрузка может занять до 10 минут
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}