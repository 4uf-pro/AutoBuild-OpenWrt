name: Build OpenWrt for Xiaomi AC1200 R4Av2 and RB02

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

jobs:
  Build-Xiaomi-R4Av2-MT7621:
    name: Build Xiaomi R4Av2 (MT7621)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev libssl-dev libelf-dev unzip zlib1g-dev python3 python3-pip liblzma-dev device-tree-compiler p7zip-full
    
    - name: Clone source code
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load custom configuration for R4Av2
      run: |
        cp xiaomi_mi-router-4a-gigabit-v2.config build.config
        sed -i 's|\r$||g' build.config
        cat build.config > openwrt/.config
        cd openwrt
        make defconfig

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s
        BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')
        echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_ENV
    
    - name: Upload firmware with config
      uses: actions/upload-artifact@v4
      with:
        name: Xiaomi_R4Av2_OpenWrt_${{ env.BUILD_TIMESTAMP }}
        path: |
          openwrt/bin/targets/ramips/mt7621/openwrt-*-xiaomi_mi-router-4a-gigabit-v2-squashfs-sysupgrade.bin
          build.config

  Build-Xiaomi-AC1200-RB02-MT7621:
    name: Build Xiaomi AC1200 RB02 (MT7621)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev libssl-dev libelf-dev unzip zlib1g-dev python3 python3-pip liblzma-dev device-tree-compiler p7zip-full
    
    - name: Clone source code
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load custom configuration for AC1200 RB02
      run: |
        cp xiaomi_mi-router-ac1200-rb02.config build.config
        sed -i 's|\r$||g' build.config
        cat build.config > openwrt/.config
        cd openwrt
        make defconfig

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s
        BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')
        echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_ENV
    
    - name: Rename firmware for RB02
      run: |
        cd openwrt/bin/targets/ramips/mt7621/
        OLD_FW=$(ls openwrt-*-xiaomi_mi-router-ac1200-squashfs-sysupgrade.bin 2>/dev/null | head -1)
        if [ -n "$OLD_FW" ]; then
          NEW_FW="${OLD_FW/xiaomi_mi-router-ac1200/xiaomi_mi-router-ac1200-rb02}"
          cp "$OLD_FW" "$NEW_FW"
        fi
    
    - name: Upload firmware with config
      uses: actions/upload-artifact@v4
      with:
        name: Xiaomi_AC1200_RB02_OpenWrt_${{ env.BUILD_TIMESTAMP }}
        path: |
          openwrt/bin/targets/ramips/mt7621/openwrt-*-xiaomi_mi-router-ac1200-rb02-squashfs-sysupgrade.bin
          build.config
  
  Create-Release:
    name: Create Release
    needs: [Build-Xiaomi-R4Av2-MT7621, Build-Xiaomi-AC1200-RB02-MT7621]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare files for release
        run: |
          mkdir -p release_files
          
          find artifacts -name "*.bin" -exec cp {} release_files/ \;
          
          find artifacts -name "*_R4Av2_OpenWrt_*" -type d -exec cp {}/build.config release_files/config_Xiaomi_R4Av2.txt \; 2>/dev/null || true
          find artifacts -name "*_AC1200_RB02_OpenWrt_*" -type d -exec cp {}/build.config release_files/config_Xiaomi_AC1200_RB02.txt \; 2>/dev/null || true
      
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}