name: Build OpenWrt for Xiaomi R4Av2 and RB02  # –ë–µ–∑ —ç–º–æ–¥–∑–∏!

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build ${{ matrix.device }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - device: Xiaomi_R4Av2
            config: xiaomi_mi-router-4a-gigabit-v2.config
            file_part: xiaomi_mi-router-4a-gigabit-v2
          - device: Xiaomi_AC1200_RB02
            config: xiaomi_mi-router-ac1200-rb02.config
            file_part: xiaomi_mi-router-ac1200
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Setup build environment  # –ë–µ–∑ —ç–º–æ–¥–∑–∏ –≤ –∏–º–µ–Ω–∏ —à–∞–≥–∞!
      run: |
        #############################################
        #          –ù–ê–°–¢–†–û–ô–ö–ê –°–†–ï–î–´ –°–ë–û–†–ö–ò           #
        #############################################
        echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥—ã —Å–±–æ—Ä–∫–∏..."
        
        sudo apt-get update
        sudo apt-get install -y \
          build-essential asciidoc binutils bzip2 gawk gettext git \
          libncurses5-dev libz-dev libssl-dev libelf-dev unzip zlib1g-dev \
          python3 python3-pip liblzma-dev device-tree-compiler p7zip-full rsync \
          time
        
        echo "‚úÖ –°—Ä–µ–¥–∞ —Å–±–æ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞!"
    
    - name: Clone OpenWRT source
      run: |
        echo "üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ OpenWRT..."
        git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout main
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "‚úÖ –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –≥–æ—Ç–æ–≤!"
    
    - name: Apply device configuration
      run: |
        #############################################
        #       –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò             #
        #############################################
        echo "üìÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
        
        if [ ! -f "configs/${{ matrix.config }}" ]; then
          echo "‚ùå –ö–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω: configs/${{ matrix.config }}"
          exit 1
        fi
        
        echo "üìÅ –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥: ${{ matrix.config }}"
        cp "configs/${{ matrix.config }}" openwrt/.config
        cd openwrt
        make defconfig
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!"
    
    - name: Prepare custom configuration files
      run: |
        #############################################
        #     –ü–û–î–ì–û–¢–û–í–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–û–ù–ù–´–• –§–ê–ô–õ–û–í    #
        #############################################
        echo "üõ†Ô∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
        
        mkdir -p openwrt/files/etc/config
        
        # üîí HTTPS DNS Proxy (DoH —á–µ—Ä–µ–∑ Cloudflare)
        cat <<EOF > openwrt/files/etc/config/https-dns-proxy
        config https-dns-proxy
            option instance 'cloudflare'
            option bootstrap_dns '1.1.1.1,1.0.0.1'
            option dns_servers '1.1.1.1,1.0.0.1'
            option resolver_url 'https://cloudflare-dns.com/dns-query'
            option listen_addr '127.0.0.1'
            option listen_port '5053'
            option user 'nobody'
            option group 'nogroup'
        EOF
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ HTTPS DNS Proxy —Å–æ–∑–¥–∞–Ω"
        
        # üîÑ –ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Dnsmasq
        mkdir -p openwrt/files/etc/uci-defaults
        cat <<'EOF' > openwrt/files/etc/uci-defaults/99-dns-setup
        #!/bin/sh
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Dnsmasq –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å DoH-–ø—Ä–æ–∫—Å–∏
        uci del dhcp.@dnsmasq[0].server 2>/dev/null
        uci add_list dhcp.@dnsmasq[0].server='127.0.0.1#5053'
        uci set dhcp.@dnsmasq[0].noresolv='1'
        uci commit dhcp
        exit 0
        EOF
        chmod +x openwrt/files/etc/uci-defaults/99-dns-setup
        echo "‚úÖ –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Dnsmasq —Å–æ–∑–¥–∞–Ω"
        
        # üíæ ZRAM —Å LZ4 —Å–∂–∞—Ç–∏–µ–º
        cat <<'EOF' > openwrt/files/etc/config/zram
        config zram 'swap'
            option compression_algorithm 'lz4'
            option disksize '48M'
            option memory_limit '96M'
            option priority '100'
            option swapiness '80'
        EOF
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ ZRAM —Å–æ–∑–¥–∞–Ω"
        
        # üéÆ SQM –¥–ª—è –Ω–∏–∑–∫–æ–≥–æ –ø–∏–Ω–≥–∞
        cat <<EOF > openwrt/files/etc/config/sqm
        config queue 'wan'
            option enabled '0'
            option interface 'wan'
            option download '85000'
            option upload '85000'
            option qdisc 'cake'
            option script 'piece_of_cake.qos'
            option linklayer 'ethernet'
        EOF
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ SQM —Å–æ–∑–¥–∞–Ω"
        
        echo "üéâ –í—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã!"
    
    - name: Build firmware image
      run: |
        #############################################
        #           –°–ë–û–†–ö–ê –ü–†–û–®–ò–í–ö–ò                #
        #############################################
        echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏..."
        echo "üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${{ matrix.device }}"
        
        cd openwrt
        time make -j$(($(nproc) + 1)) || make -j1 V=s
        
        echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(date)"
        echo "BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M')" >> $GITHUB_ENV
    
    - name: Collect build artifacts
      run: |
        #############################################
        #         –°–û–ë–ò–†–ê–ï–ú –ê–†–¢–ï–§–ê–ö–¢–´               #
        #############################################
        echo "üì¶ –°–±–æ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤..."
        
        mkdir -p "output/${{ matrix.device }}"
        
        FIRMWARE_FILE=$(find openwrt/bin/targets/ramips/mt7621/ \
          -name "*${{ matrix.file_part }}*squashfs-sysupgrade.bin" \
          -type f | head -1)
        
        if [ -f "$FIRMWARE_FILE" ]; then
          echo "‚úÖ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª: $(basename "$FIRMWARE_FILE")"
          cp "$FIRMWARE_FILE" "output/${{ matrix.device }}/"
          cp openwrt/.config "output/${{ matrix.device }}/build.config"
          echo "‚úÖ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–æ–±—Ä–∞–Ω—ã!"
        else
          echo "‚ùå –§–∞–π–ª –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: "${{ matrix.device }}_${{ env.BUILD_TIMESTAMP }}"
        path: "output/${{ matrix.device }}/*"
        retention-days: 7

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: Generate SHA256 checksums
        run: |
          echo "üîê –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã..."
          cd artifacts
          find . -name "*.bin" -type f -exec sha256sum {} \; > SHA256SUMS
          echo "‚úÖ –•–µ—à–∏ —Å–æ–∑–¥–∞–Ω—ã!"
          cat SHA256SUMS
      
      - name: Publish release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: "OpenWrt 2026 –¥–ª—è Xiaomi (${{ github.ref_name }})"
          body: |
            ## üöÄ OpenWrt 2026 Edition (v24.10.5)
            
            ### üì± –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏:
            - **Xiaomi Mi Router 4A Gigabit v2** (R4Av2)
            - **Xiaomi Mi Router AC1200** (RB02)
            
            ### üîß –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏:
            ‚úÖ **Zapret** ‚Äî –æ–±—Ö–æ–¥ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (nfqws)  
            ‚úÖ **DoH DNS** ‚Äî –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DNS —á–µ—Ä–µ–∑ Cloudflare  
            ‚úÖ **WireGuard** ‚Äî –±—ã—Å—Ç—Ä—ã–π VPN  
            ‚úÖ **SQM Cake** ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–∏–Ω–≥ –≤ –∏–≥—Ä–∞—Ö  
            ‚úÖ **Mesh Wi-Fi** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 802.11s  
            ‚úÖ **ZRAM —Å LZ4** ‚Äî –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏  
            ‚úÖ **–†—É—Å—Å–∫–∏–π LuCI**
            
            ### ‚öôÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
            1. –ü—Ä–æ—à–µ–π—Ç–µ —Ñ–∞–π–ª `sysupgrade.bin` —á–µ—Ä–µ–∑ **LuCI** –∏–ª–∏ **Breed**
            2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
            3. –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
            
            *–°–±–æ—Ä–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è 16MB Flash –ø–∞–º—è—Ç–∏.*
            
            ### üîí –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã:
            ```
            $(cat artifacts/SHA256SUMS 2>/dev/null || echo "–•–µ—à–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏")
            ```
          files: |
            artifacts/**/*.bin
            artifacts/SHA256SUMS