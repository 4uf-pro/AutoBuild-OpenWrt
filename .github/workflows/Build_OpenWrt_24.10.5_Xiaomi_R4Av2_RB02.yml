name: Build OpenWrt 24.10.5 for Xiaomi R4Av2 and RB02

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'openwrt-*-r*'  # Auto-trigger for tags like openwrt-24.10.5-r1

jobs:
  build:
    name: Build ${{ matrix.device }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - device: Xiaomi-R4Av2
            config: xiaomi_mi-router-4a-gigabit-v2.config
            file_part: xiaomi_mi-router-4a-gigabit-v2
            artifact_prefix: Xiaomi_R4Av2
            device_slug: xiaomi-r4av2
          
          - device: Xiaomi-RB02
            config: xiaomi_mi-router-ac1200-rb02.config
            file_part: xiaomi_mi-router-4a-gigabit-v2
            artifact_prefix: Xiaomi_RB02
            device_slug: xiaomi-rb02

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    # Install build dependencies
    - name: Setup build environment
      run: |
        echo "Disk space before build:"
        df -h
        
        sudo apt-get update
        sudo apt-get install -y \
          build-essential asciidoc binutils bzip2 gawk gettext git \
          libncurses5-dev libz-dev libssl-dev libelf-dev unzip zlib1g-dev \
          python3 python3-pip liblzma-dev device-tree-compiler p7zip-full rsync \
          time ccache
        
        echo "Disk space after install:"
        df -h
    
    # Cache build artifacts
    - name: Cache build artifacts
      uses: actions/cache@v3
      id: cache
      with:
        path: |
          ~/.ccache
          openwrt/dl
          openwrt/build_dir
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', '**.github/workflows/*.yml') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', '**.github/workflows/*.yml') }}-
          ${{ runner.os }}-openwrt-
    
    # Setup ccache if cache was restored
    - name: Setup ccache
      if: steps.cache.outputs.cache-hit == 'true'
      run: |
        echo "Cache restored. Build will be faster."
        ccache --show-stats || true
    
    # Clone OpenWrt source
    - name: Clone OpenWRT source
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout v24.10.5
        
        # Clear proxy variables for better connectivity
        unset http_proxy
        unset https_proxy
        unset HTTP_PROXY
        unset HTTPS_PROXY
        
        # Update feeds with retry logic
        for attempt in {1..5}; do
          echo "Updating feeds (attempt $attempt/5)"
          if ./scripts/feeds update -a -f; then
            echo "Feeds updated successfully"
            break
          fi
          echo "Feed update failed, retrying in 20 seconds..."
          sleep 20
          if [ $attempt -eq 5 ]; then
            echo "Failed to update feeds after 5 attempts"
            exit 1
          fi
        done
        
        ./scripts/feeds install -a -f
        echo "OpenWrt version: v24.10.5 (stable)"
    
    # Validate configuration files before building
    - name: Validate configurations
      run: |
        echo "Validating configuration files..."
        
        REQUIRED_CONFIGS=(
          "configs/xiaomi_mi-router-4a-gigabit-v2.config"
          "configs/xiaomi_mi-router-ac1200-rb02.config"
        )
        
        # Check if config files exist
        for config in "${REQUIRED_CONFIGS[@]}"; do
          if [ ! -f "$config" ]; then
            echo "ERROR: Config file not found: $config"
            exit 1
          fi
          echo "Found: $config"
        done
        
        # Validate each configuration
        for config in "${REQUIRED_CONFIGS[@]}"; do
          echo "Checking $config..."
          
          # Check target platform
          if ! grep -q "CONFIG_TARGET_ramips=y" "$config"; then
            echo "ERROR: Missing CONFIG_TARGET_ramips in $config"
            exit 1
          fi
          
          if ! grep -q "CONFIG_TARGET_ramips_mt7621=y" "$config"; then
            echo "ERROR: Missing CONFIG_TARGET_ramips_mt7621 in $config"
            exit 1
          fi
          
          if ! grep -q "CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-4a-gigabit-v2=y" "$config"; then
            echo "ERROR: Missing device config in $config"
            exit 1
          fi
          
          # Check for required packages
          REQUIRED_PACKAGES=(
            "CONFIG_PACKAGE_firewall4=y"
            "CONFIG_PACKAGE_dnsmasq-full=y"
            "CONFIG_PACKAGE_luci=y"
            "CONFIG_PACKAGE_kmod-wireguard=y"
          )
          
          for pkg in "${REQUIRED_PACKAGES[@]}"; do
            if ! grep -q "$pkg" "$config"; then
              echo "WARNING: Missing recommended package: $pkg"
            fi
          done
          
          # Warn about common mistakes
          if grep -q "CONFIG_PACKAGE_dnsmasq=y" "$config"; then
            echo "WARNING: Found dnsmasq instead of dnsmasq-full in $config"
          fi
          
          echo "Configuration valid: $config"
        done
        
        echo "All configuration files are valid."
    
    # Apply device-specific configuration
    - name: Apply device configuration
      run: |
        if [ ! -f "configs/${{ matrix.config }}" ]; then
          echo "Config not found: configs/${{ matrix.config }}"
          exit 1
        fi
        cp "configs/${{ matrix.config }}" openwrt/.config
        cd openwrt
        make defconfig
    
    # Prepare custom configuration files
    - name: Prepare custom configuration files
      run: |
        mkdir -p openwrt/files/etc/uci-defaults
        
        # DNS setup script (runs on first boot)
        cat <<'EOF' > openwrt/files/etc/uci-defaults/99-dns-setup
#!/bin/sh
uci del dhcp.@dnsmasq[0].server 2>/dev/null
uci add_list dhcp.@dnsmasq[0].server='127.0.0.1#5053'
uci set dhcp.@dnsmasq[0].noresolv='1'
uci commit dhcp
exit 0
EOF
        chmod +x openwrt/files/etc/uci-defaults/99-dns-setup
    
    # Build firmware image
    - name: Build firmware image
      run: |
        # Increase /tmp size for compilation
        sudo mount -o remount,size=4G /tmp
        
        cd openwrt
        export CCACHE_DIR=~/.ccache
        export CCACHE_TEMPDIR=/tmp/ccache_temp
        mkdir -p $CCACHE_TEMPDIR
        ccache --max-size=2G || true
        
        echo "Build starting with ccache enabled..."
        time make -j$(($(nproc) + 1)) CCACHE=1 || make -j1 V=s CCACHE=1
        
        echo "CCACHE STATISTICS:"
        ccache --show-stats || true
        
        echo "BUILD_DATETIME=$(date '+%Y%m%d-%H%M')" >> $GITHUB_ENV
        echo "OPENWRT_VERSION=v24.10.5" >> $GITHUB_ENV
    
    # Collect build artifacts
    - name: Collect build artifacts
      run: |
        mkdir -p "output/${{ matrix.device }}"
        
        # Find firmware file
        FIRMWARE_FILE=$(find openwrt/bin/targets/ramips/mt7621/ \
          -name "*${{ matrix.file_part }}*squashfs-sysupgrade.bin" \
          -type f | head -1)
        
        if [ -f "$FIRMWARE_FILE" ]; then
          ORIG_NAME=$(basename "$FIRMWARE_FILE")
          
          if [ "${{ matrix.device }}" = "Xiaomi-RB02" ]; then
            # For RB02: rename device and add version
            NEW_NAME=$(echo "$ORIG_NAME" | sed "s/^openwrt-/openwrt-24.10.5-/")
            NEW_NAME=$(echo "$NEW_NAME" | sed 's/xiaomi_mi-router-4a-gigabit-v2/xiaomi_mi-router-ac1200-rb02/')
            cp "$FIRMWARE_FILE" "output/${{ matrix.device }}/$NEW_NAME"
          else
            # For R4Av2: just add version prefix
            NEW_NAME=$(echo "$ORIG_NAME" | sed "s/^openwrt-/openwrt-24.10.5-/")
            cp "$FIRMWARE_FILE" "output/${{ matrix.device }}/$NEW_NAME"
          fi
          
          # Save build configuration
          cp openwrt/.config "output/${{ matrix.device }}/build.config"
          
          # Create build info file
          cat <<EOF > "output/${{ matrix.device }}/build_info.txt"
Device: ${{ matrix.device }}
OpenWrt Version: 24.10.5 (stable)
Build Time: ${{ env.BUILD_DATETIME }}
Kernel: $(grep '^LINUX_VERSION' openwrt/include/kernel-version.mk 2>/dev/null | cut -d' ' -f3 || echo "unknown")
Config: ${{ matrix.config }}
CCache Hit Rate: $(ccache --show-stats 2>/dev/null | grep 'cache hit rate' | grep -o '[0-9.]*%' || echo "N/A")
EOF
          
        else
          echo "Firmware file not found!"
          exit 1
        fi
    
    # Upload artifacts to GitHub
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: "openwrt-24.10.5-${{ matrix.device_slug }}-${{ env.BUILD_DATETIME }}"
        path: "output/${{ matrix.device }}/*"
        retention-days: 7

  # Create GitHub release when tag is pushed
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/openwrt-')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          find . -name "*.bin" -type f -exec sha256sum {} \; > SHA256SUMS
      
      - name: Extract version from tag
        run: |
          TAG_NAME="${{ github.ref_name }}"  # openwrt-24.10.5-r1
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          
          # Extract OpenWrt version (24.10.5)
          OPENWRT_VERSION=$(echo "$TAG_NAME" | sed 's/^openwrt-//; s/-r[0-9]*$//')
          echo "OPENWRT_VERSION=$OPENWRT_VERSION" >> $GITHUB_ENV
          
          # Extract release number (r1)
          RELEASE_NUMBER=$(echo "$TAG_NAME" | grep -o 'r[0-9]*$' || echo "r1")
          echo "RELEASE_NUMBER=$RELEASE_NUMBER" >> $GITHUB_ENV
      
      - name: Publish release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: "OpenWrt ${{ env.OPENWRT_VERSION }} (${{ env.RELEASE_NUMBER }}) for Xiaomi"
          body: |
            ## OpenWrt ${{ env.OPENWRT_VERSION }} (${{ env.RELEASE_NUMBER }}) for Xiaomi Routers
            
            ### Supported Devices:
            - **Xiaomi Mi Router 4A Gigabit Edition** (R4Av2)
            - **Xiaomi Mi Router AC1200** (RB02)
            
            ### Features:
            - OpenWrt ${{ env.OPENWRT_VERSION }} (stable)
            - Linux kernel 6.6.x
            - Zapret (bypass blocking)
            - DNS-over-HTTPS via Cloudflare
            - WireGuard VPN
            - SQM Cake (low latency)
            - Full Cone NAT (better gaming)
            - Mesh Wi-Fi support
            - ZRAM with LZ4 compression
            - Hardware Watchdog
            - Russian LuCI interface
            
            ### Checksums:
            ```
            $(cat artifacts/SHA256SUMS 2>/dev/null || echo "SHA256SUMS")
            ```
            
            ### Build Information:
            - Build date: $(date -u '+%Y-%m-%d %H:%M UTC')
            - OpenWrt version: ${{ env.OPENWRT_VERSION }}
            - Release: ${{ env.RELEASE_NUMBER }}
            - Configuration validated before build
            - Compiled with ccache optimization
          files: |
            artifacts/**/*.bin
            artifacts/**/*.config
            artifacts/**/*.txt
            artifacts/SHA256SUMS