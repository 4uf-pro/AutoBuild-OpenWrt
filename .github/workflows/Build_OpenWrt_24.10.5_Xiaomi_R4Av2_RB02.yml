name: Build OpenWrt 24.10.5 for Xiaomi R4Av2 and RB02

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*'  # Auto-trigger on version tags

jobs:
  build:
    name: Build ${{ matrix.device }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - device: Xiaomi_AC1200_R4Av2
            config: xiaomi_mi-router-4a-gigabit-v2.config
            file_part: xiaomi_mi-router-4a-gigabit-v2
            artifact_prefix: Xiaomi_AC1200_R4Av2
          
          - device: Xiaomi_AC1200_RB02
            config: xiaomi_mi-router-ac1200-rb02.config
            file_part: xiaomi_mi-router-4a-gigabit-v2
            artifact_prefix: Xiaomi_AC1200_RB02

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    # Install required build dependencies
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential asciidoc binutils bzip2 gawk gettext git \
          libncurses5-dev libz-dev libssl-dev libelf-dev unzip zlib1g-dev \
          python3 python3-pip liblzma-dev device-tree-compiler p7zip-full rsync \
          time
    
    # Clone OpenWrt source and checkout v24.10.5
    - name: Clone OpenWRT source
      run: |
        # Clone full repository (no depth limit for reliability)
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        # Checkout exact v24.10.5 release
        git checkout v24.10.5
        
        # Update feeds with retry logic (handles 503 server errors)
        for attempt in {1..3}; do
          echo "Attempting to update feeds #$attempt"
          if ./scripts/feeds update -a; then
            echo "Feeds updated successfully"
            break
          fi
          echo "Error, waiting 15 seconds before retry..."
          sleep 15
          if [ $attempt -eq 3 ]; then
            echo "Failed to update feeds after 3 attempts"
            exit 1
          fi
        done
        
        ./scripts/feeds install -a
        echo "OpenWrt version: v24.10.5 (stable)"
    
    # Apply device-specific configuration
    - name: Apply device configuration
      run: |
        if [ ! -f "configs/${{ matrix.config }}" ]; then
          echo "Config not found: configs/${{ matrix.config }}"
          exit 1
        fi
        cp "configs/${{ matrix.config }}" openwrt/.config
        cd openwrt
        make defconfig
    
    # Prepare custom configuration files for target system
    - name: Prepare custom configuration files
      run: |
        mkdir -p openwrt/files/etc/config
        
        # HTTPS DNS Proxy configuration (Cloudflare DoH)
        cat <<EOF > openwrt/files/etc/config/https-dns-proxy
        config https-dns-proxy
            option instance 'cloudflare'
            option bootstrap_dns '1.1.1.1,1.0.0.1'
            option dns_servers '1.1.1.1,1.0.0.1'
            option resolver_url 'https://cloudflare-dns.com/dns-query'
            option listen_addr '127.0.0.1'
            option listen_port '5053'
            option user 'nobody'
            option group 'nogroup'
        EOF
        
        # DNS setup script (runs on first boot)
        mkdir -p openwrt/files/etc/uci-defaults
        cat <<'EOF' > openwrt/files/etc/uci-defaults/99-dns-setup
        #!/bin/sh
        uci del dhcp.@dnsmasq[0].server 2>/dev/null
        uci add_list dhcp.@dnsmasq[0].server='127.0.0.1#5053'
        uci set dhcp.@dnsmasq[0].noresolv='1'
        uci commit dhcp
        exit 0
        EOF
        chmod +x openwrt/files/etc/uci-defaults/99-dns-setup
        
        # ZRAM swap configuration
        cat <<'EOF' > openwrt/files/etc/config/zram
        config zram 'swap'
            option compression_algorithm 'lz4'
            option disksize '48M'
            option memory_limit '96M'
            option priority '100'
            option swapiness '80'
        EOF
        
        # SQM QoS configuration (disabled by default)
        cat <<EOF > openwrt/files/etc/config/sqm
        config queue 'wan'
            option enabled '0'
            option interface 'wan'
            option download '85000'
            option upload '85000'
            option qdisc 'cake'
            option script 'piece_of_cake.qos'
            option linklayer 'ethernet'
        EOF
    
    # Build firmware image with parallel compilation
    - name: Build firmware image
      run: |
        cd openwrt
        time make -j$(($(nproc) + 1)) || make -j1 V=s
        echo "BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M')" >> $GITHUB_ENV
        echo "OPENWRT_VERSION=v24.10.5" >> $GITHUB_ENV
    
    # Collect and rename build artifacts
    - name: Collect build artifacts
      run: |
        mkdir -p "output/${{ matrix.device }}"
        
        # Find firmware file
        FIRMWARE_FILE=$(find openwrt/bin/targets/ramips/mt7621/ \
          -name "*${{ matrix.file_part }}*squashfs-sysupgrade.bin" \
          -type f | head -1)
        
        if [ -f "$FIRMWARE_FILE" ]; then
          ORIG_NAME=$(basename "$FIRMWARE_FILE")
          
          if [ "${{ matrix.device }}" = "Xiaomi_AC1200_RB02" ]; then
            # For RB02: rename device and add version
            NEW_NAME=$(echo "$ORIG_NAME" | sed "s/^openwrt-/openwrt-24.10.5-/")
            NEW_NAME=$(echo "$NEW_NAME" | sed 's/xiaomi_mi-router-4a-gigabit-v2/xiaomi_mi-router-ac1200-rb02/')
            cp "$FIRMWARE_FILE" "output/${{ matrix.device }}/$NEW_NAME"
          else
            # For R4Av2: just add version prefix
            NEW_NAME=$(echo "$ORIG_NAME" | sed "s/^openwrt-/openwrt-24.10.5-/")
            cp "$FIRMWARE_FILE" "output/${{ matrix.device }}/$NEW_NAME"
          fi
          
          # Save build configuration
          cp openwrt/.config "output/${{ matrix.device }}/build.config"
          
          # Create build info file
          cat <<EOF > "output/${{ matrix.device }}/build_info.txt"
          Device: ${{ matrix.device }}
          OpenWrt Version: 24.10.5 (stable)
          Build Time: ${{ env.BUILD_TIMESTAMP }}
          Kernel: $(grep '^LINUX_VERSION' openwrt/include/kernel-version.mk 2>/dev/null | cut -d' ' -f3 || echo "unknown")
          Config: ${{ matrix.config }}
          EOF
          
        else
          echo "Firmware file not found!"
          exit 1
        fi
    
    # Upload artifacts to GitHub
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: "${{ matrix.artifact_prefix }}_OpenWrt_24.10.5_${{ env.BUILD_TIMESTAMP }}"
        path: "output/${{ matrix.device }}/*"
        retention-days: 7

  # Create GitHub release when tag is pushed
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          find . -name "*.bin" -type f -exec sha256sum {} \; > SHA256SUMS
      
      - name: Publish release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: "OpenWrt 24.10.5 for Xiaomi (${{ github.ref_name }})"
          body: |
            ## OpenWrt 24.10.5 (stable) for Xiaomi Router
            
            ### Models:
            - Xiaomi AC1200 R4Av2
            - Xiaomi AC1200 RB02
            
            ### Features:
            - OpenWrt 24.10.5 (stable)
            - Linux kernel 6.6.x
            - Zapret (bypass blocking)
            - DoH DNS via Cloudflare
            - WireGuard VPN
            - SQM Cake (low latency)
            - Full Cone NAT (better gaming)
            - Mesh Wi-Fi support
            - ZRAM with LZ4 compression
            - Hardware Watchdog
            - Russian LuCI interface
            
            ### Checksums:
            ```
            $(cat artifacts/SHA256SUMS 2>/dev/null || echo "Checksums will appear here after build")
            ```
          files: |
            artifacts/**/*.bin
            artifacts/**/*.config
            artifacts/**/*.txt
            artifacts/SHA256SUMS